name: Deploy Rust-Cargo Project

on:
    push:
        branches:
            - main

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout repository
          uses: actions/checkout@v2

        - name: Set up Rust
          uses: actions-rs/toolchain@v1
          with:
              toolchain: stable

        - name: Build project
          run: cargo build --release

        - name: Upload build artifacts
          uses: actions/upload-artifact@v2
          with:
              name: build
              path: target/release/

    deploy:
        runs-on: ubuntu-latest
        needs: build

        steps:
        - name: Download build artifacts
          uses: actions/download-artifact@v2
          with:
              name: build
              path: build

        - name: Deploy to remote server
          env:
              SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
              REMOTE_USER: ${{ secrets.REMOTE_USER }}
              REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          run: |
              mkdir -p ~/.ssh
              echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
              chmod 600 ~/.ssh/id_rsa
              scp -r build/* $REMOTE_USER@$REMOTE_HOST:/path/to/deploy/
              ssh $REMOTE_USER@$REMOTE_HOST 'bash -s' < ./deploy_script.sh